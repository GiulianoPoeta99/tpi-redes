services:
  # Máquina A - Red 172.20.0.0/24
  machine-a:
    image: file-transfer-cli-lab
    container_name: ft-machine-a
    hostname: machine-a
    volumes:
      - ../tests/fixtures:/app/files:ro
      - ./volumes/lab/machine-a:/app/downloads
    networks:
      network-a:
        ipv4_address: 172.20.0.10
    privileged: true
    cap_add:
      - NET_ADMIN
    user: root
    command: >
      sh -c "
        echo 'Configurando Machine A...';
        sleep 5;
        echo 'Agregando ruta hacia red B via router...';
        ip route add 172.21.0.0/24 via 172.20.0.2 2>/dev/null || echo 'Error agregando ruta o ya existe';
        echo 'Machine A configurada';
        ip route show;
        tail -f /dev/null
      "
    environment:
      - MACHINE_NAME=Machine-A
    depends_on:
      - router

  # Máquina B - Red 172.21.0.0/24  
  machine-b:
    image: file-transfer-cli-lab
    container_name: ft-machine-b
    hostname: machine-b
    volumes:
      - ../tests/fixtures:/app/files:ro
      - ./volumes/lab/machine-b:/app/downloads
    networks:
      network-b:
        ipv4_address: 172.21.0.10
    privileged: true
    cap_add:
      - NET_ADMIN
    user: root
    command: >
      sh -c "
        echo 'Configurando Machine B...';
        sleep 5;
        echo 'Agregando ruta hacia red A via router...';
        ip route add 172.20.0.0/24 via 172.21.0.2 2>/dev/null || echo 'Error agregando ruta o ya existe';
        echo 'Machine B configurada';
        ip route show;
        tail -f /dev/null
      "
    environment:
      - MACHINE_NAME=Machine-B
    depends_on:
      - router

  # Router/Gateway que conecta ambas redes
  router:
    image: alpine:latest
    container_name: ft-router
    hostname: router
    networks:
      network-a:
        ipv4_address: 172.20.0.2
      network-b:
        ipv4_address: 172.21.0.2
    privileged: true
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    command: >
      sh -c "
        echo 'Configurando router...';
        apk add --no-cache iptables iproute2;
        sleep 2;
        echo 1 > /proc/sys/net/ipv4/ip_forward;
        sysctl -w net.ipv4.ip_forward=1;
        iptables -P FORWARD ACCEPT;
        echo 'Router configurado - IP forwarding habilitado';
        echo 'Network A: 172.20.0.0/24';
        echo 'Network B: 172.21.0.0/24';
        ip route show;
        tail -f /dev/null
      "

networks:
  network-a:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
  
  network-b:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
          gateway: 172.21.0.1

# Los volúmenes se crean automáticamente como bind mounts