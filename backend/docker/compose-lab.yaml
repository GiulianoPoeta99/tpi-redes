services:
  # MÃ¡quina A - Red 172.20.0.0/24
  machine-a:
    image: file-transfer-cli-lab
    container_name: ft-machine-a
    hostname: machine-a
    volumes:
      - ../tests/fixtures:/app/files:ro
      - ./volumes/lab/machine-a:/app/downloads
    networks:
      network-a:
        ipv4_address: 172.20.0.10
    privileged: true
    cap_add:
      - NET_ADMIN
    user: root
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ping", "-c", "1", "172.21.0.10"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    command: >
      sh -c "
        echo 'ğŸš€ Configurando Machine A...';
        
        # Wait for router to be ready
        echo 'â³ Esperando router...';
        until ping -c 1 172.20.0.2 >/dev/null 2>&1; do
          echo '  Router no disponible, reintentando...';
          sleep 2;
        done;
        echo 'âœ… Router disponible';
        
        # Configure routing with retry logic
        echo 'ğŸŒ Configurando rutas...';
        for i in {1..5}; do
          if ip route add 172.21.0.0/24 via 172.20.0.2 2>/dev/null; then
            echo 'âœ… Ruta agregada exitosamente';
            break;
          elif ip route show | grep -q '172.21.0.0/24 via 172.20.0.2'; then
            echo 'âœ… Ruta ya existe';
            break;
          else
            echo \"âš ï¸  Intento \$i/5 fallÃ³, reintentando...\";
            sleep 2;
          fi;
        done;
        
        # Verify connectivity
        echo 'ğŸ” Verificando conectividad...';
        if ping -c 2 172.21.0.10 >/dev/null 2>&1; then
          echo 'âœ… Machine A configurada y conectada';
        else
          echo 'âš ï¸  Machine A configurada pero sin conectividad completa';
        fi;
        
        echo 'ğŸ“‹ Rutas configuradas:';
        ip route show;
        
        echo 'ğŸ¯ Machine A lista para transferencias';
        tail -f /dev/null
      "
    environment:
      - MACHINE_NAME=Machine-A
      - RUST_LOG=info
    depends_on:
      router:
        condition: service_healthy

  # MÃ¡quina B - Red 172.21.0.0/24  
  machine-b:
    image: file-transfer-cli-lab
    container_name: ft-machine-b
    hostname: machine-b
    volumes:
      - ../tests/fixtures:/app/files:ro
      - ./volumes/lab/machine-b:/app/downloads
    networks:
      network-b:
        ipv4_address: 172.21.0.10
    privileged: true
    cap_add:
      - NET_ADMIN
    user: root
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ping", "-c", "1", "172.20.0.10"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    command: >
      sh -c "
        echo 'ğŸš€ Configurando Machine B...';
        
        # Wait for router to be ready
        echo 'â³ Esperando router...';
        until ping -c 1 172.21.0.2 >/dev/null 2>&1; do
          echo '  Router no disponible, reintentando...';
          sleep 2;
        done;
        echo 'âœ… Router disponible';
        
        # Configure routing with retry logic
        echo 'ğŸŒ Configurando rutas...';
        for i in {1..5}; do
          if ip route add 172.20.0.0/24 via 172.21.0.2 2>/dev/null; then
            echo 'âœ… Ruta agregada exitosamente';
            break;
          elif ip route show | grep -q '172.20.0.0/24 via 172.21.0.2'; then
            echo 'âœ… Ruta ya existe';
            break;
          else
            echo \"âš ï¸  Intento \$i/5 fallÃ³, reintentando...\";
            sleep 2;
          fi;
        done;
        
        # Verify connectivity
        echo 'ğŸ” Verificando conectividad...';
        if ping -c 2 172.20.0.10 >/dev/null 2>&1; then
          echo 'âœ… Machine B configurada y conectada';
        else
          echo 'âš ï¸  Machine B configurada pero sin conectividad completa';
        fi;
        
        echo 'ğŸ“‹ Rutas configuradas:';
        ip route show;
        
        echo 'ğŸ¯ Machine B lista para transferencias';
        tail -f /dev/null
      "
    environment:
      - MACHINE_NAME=Machine-B
      - RUST_LOG=info
    depends_on:
      router:
        condition: service_healthy

  # Router/Gateway que conecta ambas redes
  router:
    image: alpine:latest
    container_name: ft-router
    hostname: router
    networks:
      network-a:
        ipv4_address: 172.20.0.2
      network-b:
        ipv4_address: 172.21.0.2
    privileged: true
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "ping -c 1 172.20.0.1 && ping -c 1 172.21.0.1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    command: >
      sh -c "
        echo 'ğŸš€ Configurando router...';
        
        # Install required packages with retry
        echo 'ğŸ“¦ Instalando paquetes...';
        for i in {1..3}; do
          if apk add --no-cache iptables iproute2 >/dev/null 2>&1; then
            echo 'âœ… Paquetes instalados';
            break;
          else
            echo \"âš ï¸  Intento \$i/3 fallÃ³, reintentando...\";
            sleep 2;
          fi;
        done;
        
        # Configure IP forwarding
        echo 'ğŸŒ Configurando IP forwarding...';
        echo 1 > /proc/sys/net/ipv4/ip_forward;
        sysctl -w net.ipv4.ip_forward=1;
        
        # Configure iptables for forwarding
        echo 'ğŸ”¥ Configurando iptables...';
        iptables -P FORWARD ACCEPT;
        iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT;
        iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT;
        
        # Verify configuration
        echo 'ğŸ” Verificando configuraciÃ³n...';
        if [ \$(cat /proc/sys/net/ipv4/ip_forward) = '1' ]; then
          echo 'âœ… IP forwarding habilitado';
        else
          echo 'âŒ Error: IP forwarding no habilitado';
          exit 1;
        fi;
        
        echo 'âœ… Router configurado exitosamente';
        echo 'ğŸ“ Network A: 172.20.0.0/24 (gateway: 172.20.0.2)';
        echo 'ğŸ“ Network B: 172.21.0.0/24 (gateway: 172.21.0.2)';
        echo 'ğŸ“‹ Rutas:';
        ip route show;
        
        echo 'ğŸ¯ Router listo para enrutar trÃ¡fico';
        tail -f /dev/null
      "

networks:
  network-a:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
  
  network-b:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
          gateway: 172.21.0.1

# Los volÃºmenes se crean automÃ¡ticamente como bind mounts