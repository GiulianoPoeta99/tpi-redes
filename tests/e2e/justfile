# E2E Testing Justfile
# Provides convenient commands for running E2E tests

# Default recipe - show available commands
default:
    @echo "Available E2E test commands:"
    @echo ""
    @echo "Quick Tests:"
    @echo "  just smoke        - Run smoke tests (< 2 min)"
    @echo "  just regression   - Run regression tests (< 5 min)"
    @echo ""
    @echo "Category Tests:"
    @echo "  just workflows    - Test transfer workflows"
    @echo "  just platform     - Test cross-platform compatibility"
    @echo "  just performance  - Test performance and throughput"
    @echo "  just stress       - Test resource limits and stress"
    @echo "  just network      - Test network simulation"
    @echo "  just security     - Test security and validation"
    @echo ""
    @echo "Full Tests:"
    @echo "  just full         - Run complete E2E suite (30+ min)"
    @echo "  just full-large   - Run with large files enabled"
    @echo "  just full-long    - Run with long-running tests"
    @echo ""
    @echo "Utilities:"
    @echo "  just clean        - Clean test artifacts"
    @echo "  just setup        - Setup test environment"
    @echo "  just debug TEST   - Run specific test with debug output"

# Setup test environment
setup:
    @echo "ğŸ”§ Setting up E2E test environment..."
    cd ../../backend && cargo build --release
    @echo "âœ… Test environment ready"

# Clean test artifacts
clean:
    @echo "ğŸ§¹ Cleaning test artifacts..."
    cd ../../backend && cargo clean
    rm -rf /tmp/file-transfer-e2e-*
    @echo "âœ… Test artifacts cleaned"

# Quick smoke tests
smoke:
    @echo "ğŸ”¥ Running smoke tests..."
    cd ../../backend && cargo test --test e2e_suite smoke_test_basic_functionality --release

# Regression tests
regression:
    @echo "ğŸ”„ Running regression tests..."
    cd ../../backend && cargo test --test e2e_suite regression_test_core_features --release

# Workflow tests
workflows:
    @echo "ğŸ“‹ Running workflow tests..."
    cd ../../backend && cargo test --test e2e_suite test_workflows_only --release

# Cross-platform tests
platform:
    @echo "ğŸ–¥ï¸ Running cross-platform tests..."
    cd ../../backend && cargo test --test e2e_suite test_cross_platform_only --release

# Performance tests
performance:
    @echo "âš¡ Running performance tests..."
    cd ../../backend && cargo test --test e2e_suite test_performance_only --release

# Stress tests
stress:
    @echo "ğŸ’ª Running stress tests..."
    cd ../../backend && cargo test --test e2e_suite test_stress_only --release

# Network simulation tests
network:
    @echo "ğŸŒ Running network simulation tests..."
    cd ../../backend && cargo test --test e2e_suite test_network_simulation_only --release

# Security tests
security:
    @echo "ğŸ”’ Running security tests..."
    cd ../../backend && cargo test --test e2e_suite test_security_only --release

# Full E2E test suite
full:
    @echo "ğŸš€ Running complete E2E test suite..."
    cd ../../backend && cargo test --test e2e_suite run_complete_e2e_suite --release

# Full E2E with large files
full-large:
    @echo "ğŸš€ Running complete E2E test suite with large files..."
    cd ../../backend && E2E_LARGE_FILES=1 cargo test --test e2e_suite run_complete_e2e_suite --release

# Full E2E with long-running tests
full-long:
    @echo "ğŸš€ Running complete E2E test suite with long-running tests..."
    cd ../../backend && E2E_LONG_RUNNING=1 cargo test --test e2e_suite run_complete_e2e_suite --release

# Full E2E with all features
full-all:
    @echo "ğŸš€ Running complete E2E test suite with all features..."
    cd ../../backend && E2E_LARGE_FILES=1 E2E_LONG_RUNNING=1 cargo test --test e2e_suite run_complete_e2e_suite --release

# Debug specific test
debug TEST:
    @echo "ğŸ› Running test '{{TEST}}' with debug output..."
    cd ../../backend && RUST_LOG=debug cargo test --test e2e_suite {{TEST}} --release -- --nocapture

# Run tests with single thread (for debugging conflicts)
single TEST="":
    @echo "ğŸ” Running tests with single thread..."
    cd ../../backend && cargo test --test e2e_suite {{TEST}} --release -- --test-threads=1

# Performance benchmark
benchmark:
    @echo "ğŸ“Š Running performance benchmark..."
    cd ../../backend && cargo test --test e2e_suite test_performance_only --release -- --nocapture | grep -E "(MB/s|duration|bytes)"

# Memory usage test
memory:
    @echo "ğŸ§  Running memory usage tests..."
    cd ../../backend && cargo test --test e2e_suite test_memory_usage --release -- --nocapture

# Network condition tests
network-conditions:
    @echo "ğŸŒ Testing various network conditions..."
    cd ../../backend && cargo test --test e2e_suite test_various_network_conditions --release

# Security validation
security-validation:
    @echo "ğŸ”’ Running security validation..."
    cd ../../backend && cargo test --test e2e_suite test_input_validation --release

# CI simulation - run tests as CI would
ci-smoke:
    @echo "ğŸ¤– Simulating CI smoke tests..."
    cd ../../backend && timeout 300 cargo test --test e2e_suite smoke_test_basic_functionality --release

ci-regression:
    @echo "ğŸ¤– Simulating CI regression tests..."
    cd ../../backend && timeout 600 cargo test --test e2e_suite regression_test_core_features --release

ci-full:
    @echo "ğŸ¤– Simulating CI full test suite..."
    cd ../../backend && timeout 3600 cargo test --test e2e_suite test_workflows_only test_cross_platform_only test_security_only --release

# Test specific protocol
tcp-only:
    @echo "ğŸ”Œ Running TCP-only tests..."
    cd ../../backend && cargo test --test e2e_suite tcp --release

udp-only:
    @echo "ğŸ“¡ Running UDP-only tests..."
    cd ../../backend && cargo test --test e2e_suite udp --release

# Test specific file sizes
small-files:
    @echo "ğŸ“„ Testing small files (< 1MB)..."
    cd ../../backend && cargo test --test e2e_suite small --release

large-files:
    @echo "ğŸ“ Testing large files (> 100MB)..."
    cd ../../backend && E2E_LARGE_FILES=1 cargo test --test e2e_suite large --release

# Concurrent testing
concurrent:
    @echo "ğŸ”„ Testing concurrent transfers..."
    cd ../../backend && cargo test --test e2e_suite concurrent --release

# Error scenario testing
errors:
    @echo "âŒ Testing error scenarios..."
    cd ../../backend && cargo test --test e2e_suite error --release

# Watch mode for development
watch:
    @echo "ğŸ‘€ Running tests in watch mode..."
    cd ../../backend && cargo watch -x "test --test e2e_suite smoke_test_basic_functionality"

# Generate test report
report:
    @echo "ğŸ“Š Generating test report..."
    cd ../../backend && cargo test --test e2e_suite --release -- --format=json > e2e_test_results.json
    @echo "Test report saved to backend/e2e_test_results.json"

# Check test coverage
coverage:
    @echo "ğŸ“ˆ Checking test coverage..."
    cd ../../backend && cargo tarpaulin --tests --out Html --output-dir coverage/e2e

# Validate test environment
validate:
    @echo "âœ… Validating test environment..."
    @echo "Checking Rust installation..."
    rustc --version
    @echo "Checking cargo..."
    cargo --version
    @echo "Checking backend build..."
    cd ../../backend && cargo check --release
    @echo "Checking available ports..."
    netstat -tuln | grep -E ":(8080|9090|10000)" || echo "Ports available"
    @echo "Checking disk space..."
    df -h /tmp
    @echo "Environment validation complete"

# Quick health check
health:
    @echo "ğŸ¥ Running health check..."
    just validate
    just smoke
    @echo "âœ… System healthy for E2E testing"