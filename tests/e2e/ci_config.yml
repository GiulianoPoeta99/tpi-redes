# GitHub Actions CI/CD Configuration for E2E Tests
# Place this in .github/workflows/e2e-tests.yml

name: End-to-End Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quick smoke tests for every commit
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run smoke tests
      run: |
        cd backend
        cargo test --test e2e_suite smoke_test_basic_functionality --release
        
  # Core functionality regression tests
  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: smoke-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run regression tests
      run: |
        cd backend
        cargo test --test e2e_suite regression_test_core_features --release

  # Cross-platform testing matrix
  cross-platform-tests:
    name: Cross-Platform Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: smoke-tests
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run cross-platform tests
      run: |
        cd backend
        cargo test --test e2e_suite test_cross_platform_only --release
        
    - name: Run workflow tests
      run: |
        cd backend
        cargo test --test e2e_suite test_workflows_only --release

  # Performance and stress tests (longer running)
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: regression-tests
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf-test]')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run performance tests
      run: |
        cd backend
        cargo test --test e2e_suite test_performance_only --release
        
    - name: Run stress tests
      run: |
        cd backend
        cargo test --test e2e_suite test_stress_only --release

  # Network simulation tests
  network-tests:
    name: Network Simulation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: regression-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run network simulation tests
      run: |
        cd backend
        cargo test --test e2e_suite test_network_simulation_only --release

  # Security tests
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: smoke-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run security tests
      run: |
        cd backend
        cargo test --test e2e_suite test_security_only --release

  # Full E2E test suite (nightly only)
  full-e2e-suite:
    name: Full E2E Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 90
    needs: [regression-tests, cross-platform-tests, security-tests]
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[full-e2e]')
    
    env:
      E2E_LARGE_FILES: "1"
      E2E_LONG_RUNNING: "1"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run full E2E test suite
      run: |
        cd backend
        cargo test --test e2e_suite run_complete_e2e_suite --release
        
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-results
        path: backend/target/debug/deps/e2e_suite-*/output/

  # Frontend E2E tests (if applicable)
  frontend-e2e:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: smoke-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Install Rust (for Tauri)
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install Tauri dependencies (Linux)
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf
        
    - name: Run frontend E2E tests
      run: |
        cd frontend
        npm run test:e2e
        
  # Test result aggregation
  test-results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [smoke-tests, regression-tests, cross-platform-tests, security-tests, network-tests]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "Test Results Summary:"
        echo "Smoke Tests: ${{ needs.smoke-tests.result }}"
        echo "Regression Tests: ${{ needs.regression-tests.result }}"
        echo "Cross-Platform Tests: ${{ needs.cross-platform-tests.result }}"
        echo "Security Tests: ${{ needs.security-tests.result }}"
        echo "Network Tests: ${{ needs.network-tests.result }}"
        
        if [[ "${{ needs.smoke-tests.result }}" != "success" ]]; then
          echo "❌ Smoke tests failed - blocking deployment"
          exit 1
        fi
        
        if [[ "${{ needs.regression-tests.result }}" != "success" ]]; then
          echo "❌ Regression tests failed - blocking deployment"
          exit 1
        fi
        
        failed_count=0
        if [[ "${{ needs.cross-platform-tests.result }}" != "success" ]]; then
          failed_count=$((failed_count + 1))
        fi
        if [[ "${{ needs.security-tests.result }}" != "success" ]]; then
          failed_count=$((failed_count + 1))
        fi
        if [[ "${{ needs.network-tests.result }}" != "success" ]]; then
          failed_count=$((failed_count + 1))
        fi
        
        if [[ $failed_count -gt 1 ]]; then
          echo "❌ Too many test categories failed - blocking deployment"
          exit 1
        fi
        
        echo "✅ Test results acceptable for deployment"